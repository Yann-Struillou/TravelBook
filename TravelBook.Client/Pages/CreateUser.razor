@page "/createuser"
@using TravelBook.Client.Services
@using TravelBook.Client.ViewModels.Users
@using TravelBookDto.Users

<h1>Create a user</h1>

@if (!string.IsNullOrWhiteSpace(resultMessage))
{
    <div class="alert alert-info">@resultMessage</div>
}

<EditForm Model="@userModel" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label for="displayName" class="form-label">Nom complet</label>
        <InputText id="displayName" class="form-control" @bind-Value="userModel.DisplayName" />
        <ValidationMessage For="@(() => userModel.DisplayName)" />
    </div>

    <div class="mb-3">
        <label for="mailNickname" class="form-label">Mail Nickname</label>
        <InputText id="mailNickname" class="form-control" @bind-Value="userModel.MailNickName" />
        <ValidationMessage For="@(() => userModel.MailNickName)" />
    </div>

    <div class="mb-3">
        <label for="userPrincipalName" class="form-label">User Principal Name</label>
        <InputText id="userPrincipalName" class="form-control" @bind-Value="userModel.UserPrincipalName" />
        <ValidationMessage For="@(() => userModel.UserPrincipalName)" />
    </div>

    <button type="submit" class="btn btn-primary">Créer l'utilisateur</button>
</EditForm>


@code {
    [Inject]
    public UsersService UsersService { get; set; } = default!;

    private CreateUserFormModel userModel = new();
    private string resultMessage = string.Empty;
    private string resultMessageCss = "alert-info";

    private async Task HandleValidSubmit()
    {
        try
        {
            var createdUser = await UsersService.CreateUserAsync(new CreateUserDto(
                userModel.UserPrincipalName,
                userModel.DisplayName,
                userModel.MailNickName
            ));
            resultMessage = $"Utilisateur créé : {createdUser?.UserDisplayName} ({createdUser?.UserPrincipalName})";
            resultMessageCss = "alert-success";
            userModel = new CreateUserFormModel(); // Reset du formulaire
        }
        catch (Exception ex)
        {
            resultMessage = $"Erreur : {ex.Message}";
            resultMessageCss = "alert-danger";
        }
    }
}
