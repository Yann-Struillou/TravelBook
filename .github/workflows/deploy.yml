name: Deploy TravelBook (non-Swarm)

on:
  push:
    branches:
      - self-hosted-test

jobs:
  deploy:
    runs-on: travelbook

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------
      # CrÃ©er le dossier secrets local
      # --------------------------------------
      - name: Create secrets folder
        run: mkdir -p ./secrets

      - name: Add secrets files
        run: |
          echo "${{ secrets.BLAZORWEBAPPENTRA_CLIENT_ID }}" > ./secrets/travelbook_azure_client_id
          echo "${{ secrets.BLAZORWEBAPPENTRA_CLIENT_SECRET }}" > ./secrets/travelbook_azure_client_secret
          echo "${{ secrets.BLAZORWEBAPPENTRA_TENANT_ID }}" > ./secrets/travelbook_azure_tenant_id
          echo "${{ secrets.BLAZORWEBAPPENTRA_KEYVAULT_URI }}" > ./secrets/travelbook_keyvault_uri
          echo "${{ secrets.TRAVELBOOK_APP_CERTIFICATE_SECRET }}" > ./secrets/travelbook_pfx_password

      # --------------------------------------
      # Build et lancer le container
      # --------------------------------------
      - name: Build and run Docker Compose
        run: |
          docker compose -f docker-compose.yml build
          docker compose -f docker-compose.yml up -d

      # --------------------------------------
      # Diagnostics (optionnel)
      # --------------------------------------
      - name: Show running containers
        run: docker ps

      - name: Cleanup unused images
        run: docker image prune -f
