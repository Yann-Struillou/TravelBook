name: Deploy TravelBook (self-hosted)

on:
  push:
    branches:
      - self-hosted-test

jobs:
  deploy:
    runs-on: travelbook

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure Docker Swarm is initialized
        run: |
          docker info | grep -q "Swarm: active" || docker swarm init

      - name: Build Docker image
        run: docker build -t travelbook_app:latest -f TravelBook/Dockerfile .

      # ------------------------------------------------------------
      # Create Docker secrets (idempotent)
      # ------------------------------------------------------------
      - name: Create Docker secrets
        run: |
          echo "${{ secrets.BLAZORWEBAPPENTRA_CLIENT_ID }}" | docker secret create travelbook_azure_client_id - || true
          echo "${{ secrets.BLAZORWEBAPPENTRA_CLIENT_SECRET }}" | docker secret create travelbook_azure_client_secret - || true
          echo "${{ secrets.BLAZORWEBAPPENTRA_TENANT_ID }}" | docker secret create travelbook_azure_tenant_id - || true
          echo "${{ secrets.BLAZORWEBAPPENTRA_KEYVAULT_URI }}" | docker secret create travelbook_keyvault_uri - || true
          echo "${{ secrets.TRAVELBOOK_APP_CERTIFICATE_SECRET }}" | docker secret create travelbook_pfx_password - || true

      # ------------------------------------------------------------
      # Remove existing stack (to apply updated secrets)
      # ------------------------------------------------------------
      - name: Remove existing stack
        run: docker stack rm travelbook || true

      - name: Wait for stack removal
        run: sleep 15

      # ------------------------------------------------------------
      # Deploy stack
      # ------------------------------------------------------------
      - name: Deploy stack
        run: docker stack deploy -c docker-compose.yml travelbook

      # ------------------------------------------------------------
      # Wait for services to start
      # ------------------------------------------------------------
      - name: Wait for services
        run: sleep 15

      # ------------------------------------------------------------
      # Diagnostics
      # ------------------------------------------------------------
      - name: Show services
        run: docker stack services travelbook

      - name: Show tasks
        run: docker stack ps travelbook

      - name: Cleanup unused images
        run: docker image prune -f
